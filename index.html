<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Mängelbericht Brandschutz</title>
    <style>
      :root {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        line-height: 1.5;
        color: #111827;
        background-color: #f3f4f6;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        padding: 1rem;
        display: flex;
        justify-content: center;
      }
      .app {
        width: 100%;
        max-width: 1100px;
        background: #ffffff;
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
      }
      h1 {
        margin: 0 0 0.25rem;
        font-size: 1.8rem;
        text-align: center;
      }
      .subtitle {
        text-align: center;
        margin-bottom: 1.25rem;
        color: #6b7280;
      }

      .meta-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 0.75rem 1rem;
        margin-bottom: 1.5rem;
      }
      .field {
        display: flex;
        flex-direction: column;
        gap: 0.2rem;
      }
      .field label {
        font-size: 0.85rem;
        color: #374151;
      }
      .field input,
      .field select,
      .field textarea {
        padding: 0.4rem 0.55rem;
        border-radius: 0.5rem;
        border: 1px solid #d1d5db;
        font: inherit;
      }
      .field input:focus,
      .field select:focus,
      .field textarea:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 1px #2563eb33;
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        justify-content: flex-end;
        margin-bottom: 0.75rem;
      }
      button {
        border-radius: 999px;
        border: none;
        padding: 0.45rem 0.9rem;
        font: inherit;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
      }
      .btn-primary {
        background: #2563eb;
        color: #ffffff;
      }
      .btn-secondary {
        background: #e5e7eb;
        color: #111827;
      }
      .btn-danger {
        background: #ef4444;
        color: #ffffff;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.85rem;
      }
      thead {
        position: sticky;
        top: 0;
        background: #f9fafb;
        z-index: 1;
      }
      th,
      td {
        border: 1px solid #e5e7eb;
        padding: 0.25rem;
        vertical-align: top;
      }
      th {
        text-align: left;
        font-weight: 600;
        color: #374151;
        background: #f3f4f6;
      }
      tbody tr:nth-child(even) {
        background: #f9fafb;
      }
      td input[type="text"],
      td textarea,
      td select {
        width: 100%;
        border-radius: 0.35rem;
        border: 1px solid #d1d5db;
        padding: 0.25rem 0.35rem;
        font: inherit;
      }
      td textarea {
        resize: vertical;
        min-height: 2.2rem;
      }
      .rows-tall td textarea {
        min-height: 3.5rem;
      }
      td input:focus,
      td textarea:focus,
      td select:focus {
        outline: none;
        border-color: #2563eb;
        box-shadow: 0 0 0 1px #2563eb33;
      }
      td input[type="checkbox"] {
        width: auto;
        transform: scale(1.1);
        margin: 0.3rem 0.15rem;
      }

      @media print {
        body {
          background: white;
          padding: 0;
        }
        .app {
          box-shadow: none;
        }
        .controls {
          display: none !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="app" id="app">
      <h1>Mängelbericht</h1>
      <p class="subtitle">Erfassung von Brandschutzmängeln</p>

      <section class="meta">
        <div class="meta-grid">
          <div class="field">
            <label for="kunde">Kunde</label>
            <input id="kunde" data-meta="kunde" type="text" />
          </div>
          <div class="field">
            <label for="objekt">Objekt</label>
            <input id="objekt" data-meta="objekt" type="text" />
          </div>
          <div class="field">
            <label for="gewerk">Gewerk</label>
            <select id="gewerk" data-meta="gewerk">
              <option value="">– bitte wählen –</option>
              <option>Löschwassertechnik</option>
              <option>Tragbare Feuerlöscher</option>
              <option>Fahrbare Feuerlöscher</option>
              <option>RWA / Entrauchung</option>
              <option>Brandschutz- und Rauchschutztüren</option>
              <option>Sonstiges</option>
            </select>
          </div>
          <div class="field">
            <label for="wartungsnr">Wartungsbericht-Nr.</label>
            <input id="wartungsnr" data-meta="wartungsnr" type="text" />
          </div>
          <div class="field">
            <label for="datumWartung">Datum der Wartung</label>
            <input id="datumWartung" data-meta="datumWartung" type="date" />
          </div>
          <div class="field">
            <label for="datumBegehung">Datum der Begehung</label>
            <input id="datumBegehung" data-meta="datumBegehung" type="date" />
          </div>
        </div>
      </section>

      <section class="list">
        <div class="controls">
          <button class="btn-secondary" id="expandRows">
            Zeilenhöhe umschalten
          </button>
          <button class="btn-danger" id="clearAll">Alles löschen</button>
          <button class="btn-secondary" id="printBtn">Drucken / PDF</button>
          <button class="btn-primary" id="addRow">+ Mangel hinzufügen</button>
        </div>

        <div class="table-wrapper">
          <table>
            <thead>
              <tr>
                <th>Mangel-Nr.</th>
                <th>Nummer</th>
                <th>Tür-ID</th>
                <th>Etage</th>
                <th>Bereich</th>
                <th>Erforderliche Maßnahme</th>
                <th>Dringlichkeit</th>
                <th>Foto gemacht</th>
                <th>Foto-Dateiname</th>
                <th>Bemerkung</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </section>
    </div>

    <script>
      (function () {
        const STORAGE_KEY = "maengelberichtAppV1";

        const META_FIELDS = [
          "kunde",
          "objekt",
          "gewerk",
          "wartungsnr",
          "datumWartung",
          "datumBegehung",
        ];

        const ROW_FIELDS = [
          "mangelNr",
          "nummer",
          "tuerId",
          "etage",
          "bereich",
          "massnahme",
          "dringlichkeit",
          "fotoGemacht",
          "fotoDatei",
          "bemerkung",
        ];

        const appEl = document.getElementById("app");
        const rowsTbody = document.getElementById("rows");
        const addRowBtn = document.getElementById("addRow");
        const clearBtn = document.getElementById("clearAll");
        const expandBtn = document.getElementById("expandRows");
        const printBtn = document.getElementById("printBtn");

        let rowsTall = false;

        function createRow(data = {}) {
          const tr = document.createElement("tr");

          function createInput(field) {
            const input = document.createElement("input");
            input.type = "text";
            input.dataset.field = field;
            input.value = data[field] ?? "";
            return input;
          }

          function createTextarea(field) {
            const ta = document.createElement("textarea");
            ta.dataset.field = field;
            ta.value = data[field] ?? "";
            return ta;
          }

          function createSelectDringlichkeit() {
            const select = document.createElement("select");
            select.dataset.field = "dringlichkeit";
            ["", "Niedrig", "Normal", "Hoch", "Sofort"].forEach((opt) => {
              const o = document.createElement("option");
              o.value = opt;
              o.textContent = opt === "" ? "–" : opt;
              select.appendChild(o);
            });
            select.value = data.dringlichkeit ?? "";
            return select;
          }

          function createCheckbox(field) {
            const cb = document.createElement("input");
            cb.type = "checkbox";
            cb.dataset.field = field;
            cb.checked = Boolean(data[field]);
            return cb;
          }

          const cells = [
            createInput("mangelNr"),
            createInput("nummer"),
            createInput("tuerId"),
            createInput("etage"),
            createInput("bereich"),
            createTextarea("massnahme"),
            createSelectDringlichkeit(),
            createCheckbox("fotoGemacht"),
            createInput("fotoDatei"),
            createTextarea("bemerkung"),
          ];

          cells.forEach((control) => {
            const td = document.createElement("td");
            td.appendChild(control);
            tr.appendChild(td);
          });

          rowsTbody.appendChild(tr);
        }

        function addRow(empty = false) {
          createRow(empty ? {} : undefined);
        }

        function getState() {
          const meta = {};
          META_FIELDS.forEach((key) => {
            const el = document.querySelector("[data-meta='" + key + "']");
            if (!el) return;
            if (el.type === "date") {
              meta[key] = el.value;
            } else {
              meta[key] = el.value;
            }
          });

          const rows = [];
          rowsTbody.querySelectorAll("tr").forEach((tr) => {
            const rowData = {};
            ROW_FIELDS.forEach((field) => {
              const el = tr.querySelector("[data-field='" + field + "']");
              if (!el) return;
              if (el.type === "checkbox") {
                rowData[field] = el.checked;
              } else {
                rowData[field] = el.value;
              }
            });
            // leere Zeilen komplett ignorieren
            const hasContent = Object.values(rowData).some((v) => {
              if (typeof v === "boolean") return v;
              return (v || "").toString().trim() !== "";
            });
            if (hasContent) rows.push(rowData);
          });

          return { meta, rows };
        }

        function saveAll() {
          const state = getState();
          try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
          } catch (e) {
            console.warn("Konnte nicht speichern:", e);
          }
        }

        function loadAll() {
          let state = null;
          try {
            const raw = localStorage.getItem(STORAGE_KEY);
            if (raw) state = JSON.parse(raw);
          } catch (e) {
            console.warn("Konnte gespeicherte Daten nicht laden:", e);
          }
          if (!state) {
            addRow(true);
            return;
          }

          META_FIELDS.forEach((key) => {
            const el = document.querySelector("[data-meta='" + key + "']");
            if (!el) return;
            el.value = state.meta?.[key] ?? "";
          });

          rowsTbody.innerHTML = "";
          if (Array.isArray(state.rows) && state.rows.length) {
            state.rows.forEach((row) => createRow(row));
          } else {
            addRow(true);
          }
        }

        function clearAllData() {
          if (!confirm("Alle Einträge und Kopfdaten löschen?")) return;
          try {
            localStorage.removeItem(STORAGE_KEY);
          } catch (e) {
            console.warn(e);
          }
          META_FIELDS.forEach((key) => {
            const el = document.querySelector("[data-meta='" + key + "']");
            if (el) el.value = "";
          });
          rowsTbody.innerHTML = "";
          addRow(true);
        }

        function toggleRowHeight() {
          rowsTall = !rowsTall;
          appEl.classList.toggle("rows-tall", rowsTall);
        }

        // Events
        addRowBtn.addEventListener("click", () => {
          addRow(true);
          saveAll();
        });

        clearBtn.addEventListener("click", clearAllData);
        expandBtn.addEventListener("click", toggleRowHeight);
        printBtn.addEventListener("click", () => window.print());

        document
          .querySelectorAll("[data-meta]")
          .forEach((el) =>
            ["input", "change"].forEach((ev) =>
              el.addEventListener(ev, saveAll)
            )
          );

        rowsTbody.addEventListener("input", saveAll);
        rowsTbody.addEventListener("change", saveAll);

        // initial
        loadAll();
      })();
    </script>
  </body>
</html>
