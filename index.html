<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>M√§ngelbericht ‚Äì Erfassung</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.5;
      color: #111827;
      background-color: #f3f4f6;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 1rem;
      display: flex;
      justify-content: center;
    }

    .app {
      max-width: 1100px;
      width: 100%;
      background: #ffffff;
      border-radius: 0.75rem;
      padding: 1.25rem;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.15);
    }

    h1 {
      margin: 0 0 0.25rem;
      font-size: 1.6rem;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      font-size: 0.9rem;
      color: #6b7280;
      margin-bottom: 1rem;
    }

    .meta-section {
      border: 1px solid #e5e7eb;
      border-radius: 0.75rem;
      padding: 0.75rem;
      background: #f9fafb;
      margin-bottom: 1rem;
    }

    .meta-title {
      font-weight: 600;
      font-size: 0.95rem;
      margin-bottom: 0.5rem;
    }

    .meta-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(210px, 1fr));
      gap: 0.5rem 0.75rem;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.1rem;
      font-size: 0.85rem;
    }

    .field label {
      font-weight: 500;
      color: #374151;
    }

    .field input,
    .field select,
    .field textarea {
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      padding: 0.4rem 0.55rem;
      font-size: 0.85rem;
      width: 100%;
    }

    .field input:focus,
    .field select:focus,
    .field textarea:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb33;
    }

    .table-wrapper {
      margin-top: 1rem;
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    thead {
      background: #f3f4f6;
    }

    th,
    td {
      border-bottom: 1px solid #e5e7eb;
      padding: 0.35rem;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-weight: 600;
      color: #374151;
      position: sticky;
      top: 0;
      background: #f3f4f6;
      z-index: 1;
    }

    td input,
    td select,
    td textarea {
      width: 100%;
      font-size: 0.78rem;
      border-radius: 0.4rem;
      border: 1px solid #d1d5db;
      padding: 0.25rem 0.35rem;
    }

    td textarea {
      resize: vertical;
      min-height: 2.2rem;
      max-height: 6rem;
    }

    td input[type="checkbox"] {
      width: auto;
      margin-top: 0.15rem;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      justify-content: space-between;
      margin-top: 0.75rem;
    }

    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    button {
      border-radius: 999px;
      padding: 0.35rem 0.9rem;
      border: none;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      white-space: nowrap;
    }

    .btn-primary {
      background: #2563eb;
      color: white;
    }

    .btn-primary:hover {
      background: #1d4ed8;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    .btn-secondary:hover {
      background: #d1d5db;
    }

    .btn-danger {
      background: #ef4444;
      color: white;
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    .btn-icon {
      font-size: 1rem;
      line-height: 1;
    }

    .preview {
      margin-top: 1rem;
      border-radius: 0.75rem;
      border: 1px dashed #d1d5db;
      padding: 0.75rem;
      background: #fafafa;
    }

    .preview label {
      font-size: 0.8rem;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.25rem;
      color: #4b5563;
    }

    .preview textarea {
      width: 100%;
      min-height: 130px;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      padding: 0.4rem 0.55rem;
      font-size: 0.78rem;
      resize: vertical;
      background: #f9fafb;
    }

    .hint {
      font-size: 0.7rem;
      color: #6b7280;
      margin-top: 0.15rem;
    }

    @media (max-width: 640px) {
      .app {
        padding: 0.9rem;
      }

      h1 {
        font-size: 1.3rem;
      }

      th,
      td {
        padding: 0.3rem 0.25rem;
      }

      .btn-row {
        flex-direction: column;
        align-items: stretch;
      }

      .btn-group {
        justify-content: flex-start;
      }

      button {
        justify-content: center;
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>M√§ngelbericht</h1>
    <div class="subtitle">
      Erfassung von T√ºr- und Brandschutzm√§ngeln ‚Ä¢ Daten werden nur lokal im Browser gespeichert
    </div>

    <section class="meta-section">
      <div class="meta-title">Stammdaten</div>
      <div class="meta-grid">
        <div class="field">
          <label for="kunde">Kunde</label>
          <input id="kunde" data-meta="kunde" type="text" placeholder="Firmenname / Kunde" />
        </div>
        <div class="field">
          <label for="objekt">Objekt</label>
          <input id="objekt" data-meta="objekt" type="text" placeholder="Objektname, Stra√üe, Ort" />
        </div>
        <div class="field">
          <label for="gewerk">Gewerk</label>
          <select id="gewerk" data-meta="gewerk">
            <option value="">Bitte w√§hlen ‚Ä¶</option>
            <option value="L√∂schwassertechnik">L√∂schwassertechnik</option>
            <option value="Tragbare Feuerl√∂scher">Tragbare Feuerl√∂scher</option>
            <option value="Fahrbare Feuerl√∂scher">Fahrbare Feuerl√∂scher</option>
            <option value="RWA / Entrauchung">RWA / Entrauchung</option>
            <option value="Brandschutz- und Rauchschutzt√ºren">Brandschutz- und Rauchschutzt√ºren</option>
            <option value="Sonstiges">Sonstiges</option>
          </select>
        </div>
        <div class="field">
          <label for="wartungsbericht">Wartungsbericht-Nr.</label>
          <input id="wartungsbericht" data-meta="wartungsbericht" type="text" placeholder="z. B. 2025-00123" />
        </div>
        <div class="field">
          <label for="datum-wartung">Datum der Wartung</label>
          <input id="datum-wartung" data-meta="datumWartung" type="date" />
        </div>
        <div class="field">
          <label for="datum-begehung">Datum der Begehung</label>
          <input id="datum-begehung" data-meta="datumBegehung" type="date" />
        </div>
      </div>
    </section>

    <section class="table-section">
      <div class="meta-title">M√§ngelliste</div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th style="width: 90px;">Mangel-Nr.</th>
              <th style="width: 120px;">Bereich / Etage</th>
              <th>Erforderliche Ma√ünahme</th>
              <th style="width: 105px;">Dringlichkeit</th>
              <th style="width: 85px;">Foto gemacht</th>
              <th style="width: 130px;">Foto-Dateiname</th>
              <th>Bemerkung</th>
              <th style="width: 40px;"></th>
            </tr>
          </thead>
          <tbody id="rows-body"></tbody>
        </table>
      </div>

      <div class="btn-row">
        <div class="btn-group">
          <button type="button" id="add-row" class="btn-primary">
            <span class="btn-icon">Ôºã</span> Neuer Mangel
          </button>
          <button type="button" id="generate-text" class="btn-secondary">
            Textvorschau aktualisieren
          </button>
        </div>
        <button type="button" id="clear-all" class="btn-danger">
          <span class="btn-icon">üóë</span> Alles l√∂schen
        </button>
      </div>
    </section>

    <section class="preview">
      <label for="preview-text">
        Textvorschau f√ºr Angebot / Bericht
      </label>
      <textarea id="preview-text" readonly></textarea>
      <div class="hint">
        Den Text kannst du markieren, kopieren und in Word, Notion oder dein Angebot einf√ºgen.
      </div>
    </section>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = "maengelbericht_app_v1";

      const metaInputs = document.querySelectorAll("[data-meta]");
      const tbody = document.getElementById("rows-body");
      const addRowBtn = document.getElementById("add-row");
      const clearBtn = document.getElementById("clear-all");
      const generateBtn = document.getElementById("generate-text");
      const previewEl = document.getElementById("preview-text");

      function createRow(data) {
        const tr = document.createElement("tr");

        // Mangel-Nr.
        const tdNummer = document.createElement("td");
        const nummerInput = document.createElement("input");
        nummerInput.type = "text";
        nummerInput.placeholder = "z. B. 32611";
        nummerInput.value = data?.nummer || "";
        tdNummer.appendChild(nummerInput);
        tr.appendChild(tdNummer);

        // Bereich / Etage
        const tdBereich = document.createElement("td");
        const bereichInput = document.createElement("input");
        bereichInput.type = "text";
        bereichInput.placeholder = "z. B. EG Flur 1.1";
        bereichInput.value = data?.bereich || "";
        tdBereich.appendChild(bereichInput);
        tr.appendChild(tdBereich);

        // Ma√ünahme
        const tdMassnahme = document.createElement("td");
        const massnahmeInput = document.createElement("textarea");
        massnahmeInput.placeholder = "Ben√∂tigte Ma√ünahme / Material ‚Ä¶";
        massnahmeInput.value = data?.massnahme || "";
        tdMassnahme.appendChild(massnahmeInput);
        tr.appendChild(tdMassnahme);

        // Dringlichkeit
        const tdDringlichkeit = document.createElement("td");
        const dringlichkeitSelect = document.createElement("select");
        ["", "Niedrig", "Mittel", "Hoch", "Kritisch"].forEach((level) => {
          const opt = document.createElement("option");
          opt.value = level;
          opt.textContent = level === "" ? "‚Äì" : level;
          dringlichkeitSelect.appendChild(opt);
        });
        dringlichkeitSelect.value = data?.dringlichkeit || "";
        tdDringlichkeit.appendChild(dringlichkeitSelect);
        tr.appendChild(tdDringlichkeit);

        // Foto gemacht
        const tdFoto = document.createElement("td");
        const fotoLabel = document.createElement("label");
        fotoLabel.style.display = "flex";
        fotoLabel.style.alignItems = "center";
        fotoLabel.style.gap = "0.25rem";
        const fotoCheckbox = document.createElement("input");
        fotoCheckbox.type = "checkbox";
        fotoCheckbox.checked = !!data?.fotoGemacht;
        const fotoSpan = document.createElement("span");
        fotoSpan.textContent = "Ja";
        fotoSpan.style.fontSize = "0.75rem";
        fotoLabel.appendChild(fotoCheckbox);
        fotoLabel.appendChild(fotoSpan);
        tdFoto.appendChild(fotoLabel);
        tr.appendChild(tdFoto);

        // Foto-Dateiname
        const tdFotoName = document.createElement("td");
        const fotoNameInput = document.createElement("input");
        fotoNameInput.type = "text";
        fotoNameInput.placeholder = "z. B. IMG_1234.jpg";
        fotoNameInput.value = data?.fotoDateiname || "";
        tdFotoName.appendChild(fotoNameInput);
        tr.appendChild(tdFotoName);

        // Bemerkung
        const tdBemerkung = document.createElement("td");
        const bemerkungInput = document.createElement("textarea");
        bemerkungInput.placeholder = "Optionale Zusatzinfos ‚Ä¶";
        bemerkungInput.value = data?.bemerkung || "";
        tdBemerkung.appendChild(bemerkungInput);
        tr.appendChild(tdBemerkung);

        // L√∂schen-Button
        const tdDelete = document.createElement("td");
        const delBtn = document.createElement("button");
        delBtn.type = "button";
        delBtn.textContent = "‚úï";
        delBtn.title = "Zeile l√∂schen";
        delBtn.className = "btn-danger";
        delBtn.style.padding = "0.15rem 0.45rem";
        delBtn.style.fontSize = "0.75rem";
        tdDelete.appendChild(delBtn);
        tr.appendChild(tdDelete);

        // Listener f√ºr alle Eingaben
        tr.querySelectorAll("input, select, textarea").forEach((el) => {
          el.addEventListener("input", saveAll);
          el.addEventListener("change", saveAll);
        });

        delBtn.addEventListener("click", () => {
          tr.remove();
          saveAll();
        });

        tbody.appendChild(tr);
      }

      function collectData() {
        const data = {
          meta: {},
          rows: [],
        };

        metaInputs.forEach((el) => {
          const key = el.dataset.meta;
          data.meta[key] = el.value || "";
        });

        tbody.querySelectorAll("tr").forEach((tr) => {
          const cells = tr.querySelectorAll("td");
          const row = {
            nummer: cells[0].querySelector("input").value.trim(),
            bereich: cells[1].querySelector("input").value.trim(),
            massnahme: cells[2].querySelector("textarea").value.trim(),
            dringlichkeit: cells[3].querySelector("select").value,
            fotoGemacht: cells[4].querySelector("input[type='checkbox']").checked,
            fotoDateiname: cells[5].querySelector("input").value.trim(),
            bemerkung: cells[6].querySelector("textarea").value.trim(),
          };
          // Nur Zeilen mit Inhalt speichern
          const hasContent =
            row.nummer ||
            row.bereich ||
            row.massnahme ||
            row.fotoDateiname ||
            row.bemerkung;
          if (hasContent) {
            data.rows.push(row);
          }
        });

        return data;
      }

      function saveAll() {
        const data = collectData();
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        } catch (e) {
          console.error("Konnte nicht in localStorage speichern:", e);
        }
      }

      function loadAll() {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          createRow();
          return;
        }

        let data;
        try {
          data = JSON.parse(raw);
        } catch (e) {
          console.error("Fehler beim Laden der Daten:", e);
          createRow();
          return;
        }

        if (data.meta) {
          metaInputs.forEach((el) => {
            const key = el.dataset.meta;
            if (key in data.meta) {
              el.value = data.meta[key];
            }
          });
        }

        tbody.innerHTML = "";
        if (Array.isArray(data.rows) && data.rows.length > 0) {
          data.rows.forEach((row) => createRow(row));
        } else {
          createRow();
        }
      }

      function clearAll() {
        if (!confirm("Alle eingegebenen Daten wirklich l√∂schen?")) return;
        localStorage.removeItem(STORAGE_KEY);
        metaInputs.forEach((el) => (el.value = ""));
        tbody.innerHTML = "";
        createRow();
        previewEl.value = "";
      }

      function generateTextPreview() {
        const data = collectData();
        const lines = [];

        const m = data.meta;

        lines.push("M√§ngelbericht");
        lines.push("==============");
        if (m.kunde) lines.push("Kunde: " + m.kunde);
        if (m.objekt) lines.push("Objekt: " + m.objekt);
        if (m.gewerk) lines.push("Gewerk: " + m.gewerk);
        if (m.wartungsbericht) lines.push("Wartungsbericht-Nr.: " + m.wartungsbericht);
        if (m.datumWartung) lines.push("Datum der Wartung: " + m.datumWartung);
        if (m.datumBegehung) lines.push("Datum der Begehung: " + m.datumBegehung);
        lines.push("");

        if (data.rows.length === 0) {
          lines.push("Keine M√§ngel erfasst.");
        } else {
          lines.push("Erfasste M√§ngel:");
          lines.push("");
          data.rows.forEach((row, index) => {
            const nrLabel = row.nummer || `Pos. ${index + 1}`;
            lines.push(nrLabel);
            lines.push("-".repeat(nrLabel.length));

            if (row.bereich) lines.push("Bereich / Etage: " + row.bereich);
            if (row.massnahme) lines.push("Erforderliche Ma√ünahme: " + row.massnahme);
            if (row.dringlichkeit) lines.push("Dringlichkeit: " + row.dringlichkeit);
            if (row.fotoGemacht) {
              const fn = row.fotoDateiname || "";
              lines.push("Foto: aufgenommen" + (fn ? " (" + fn + ")" : ""));
            } else if (row.fotoDateiname) {
              lines.push("Foto-Dateiname: " + row.fotoDateiname);
            }
            if (row.bemerkung) lines.push("Bemerkung: " + row.bemerkung);

            lines.push("");
          });
        }

        previewEl.value = lines.join("\n");
      }

      addRowBtn.addEventListener("click", () => {
        createRow();
        saveAll();
      });

      clearBtn.addEventListener("click", clearAll);
      generateBtn.addEventListener("click", generateTextPreview);

      metaInputs.forEach((el) => {
        el.addEventListener("input", saveAll);
        el.addEventListener("change", saveAll);
      });

      loadAll();
      generateTextPreview();
    })();
  </script>
</body>
</html>
