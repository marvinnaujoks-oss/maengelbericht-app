<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>M√§ngelbericht ‚Äì Erfassung</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      line-height: 1.5;
      color: #111827;
      background-color: #f3f4f6;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 1rem;
      display: flex;
      justify-content: center;
    }

    .app {
      max-width: 1100px;
      width: 100%;
      background: #ffffff;
      border-radius: 1rem;
      padding: 1.25rem 1.25rem 1.75rem;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.12);
    }

    header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      gap: 0.75rem;
      margin-bottom: 1rem;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 0.75rem;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    header h1 span.icon {
      font-size: 1.6rem;
    }

    header .sub {
      font-size: 0.85rem;
      color: #6b7280;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.2rem 0.6rem;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .section-title {
      font-size: 0.95rem;
      font-weight: 600;
      margin: 1rem 0 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
    }

    .section-title span {
      font-size: 1.1rem;
    }

    .meta-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 0.2rem;
      font-size: 0.8rem;
    }

    .field label {
      font-weight: 500;
      color: #374151;
    }

    .field small {
      color: #9ca3af;
      font-size: 0.7rem;
    }

    input[type="text"],
    input[type="date"],
    select,
    textarea {
      font: inherit;
      padding: 0.35rem 0.45rem;
      border-radius: 0.5rem;
      border: 1px solid #d1d5db;
      background: #f9fafb;
      transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
      width: 100%;
    }

    textarea {
      resize: vertical;
      min-height: 2.1rem;
    }

    input[type="text"]:focus,
    input[type="date"]:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #2563eb;
      background: #ffffff;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.35);
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 0.75rem;
      margin-top: 0.35rem;
      margin-bottom: 0.35rem;
    }

    .toolbar-left,
    .toolbar-right {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 0.4rem;
    }

    button {
      font: inherit;
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 0.25rem 0.7rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.8rem;
      background: #111827;
      color: white;
      box-shadow: 0 10px 18px rgba(15, 23, 42, 0.25);
      transition: background 0.15s, transform 0.05s, box-shadow 0.15s;
    }

    button span {
      font-size: 0.9rem;
    }

    button.secondary {
      background: #f3f4f6;
      color: #111827;
      border-color: #e5e7eb;
      box-shadow: none;
    }

    button.danger {
      background: #fee2e2;
      color: #b91c1c;
      border-color: #fecaca;
      box-shadow: none;
    }

    button:hover {
      transform: translateY(-1px);
    }

    button:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .hint {
      font-size: 0.7rem;
      color: #9ca3af;
    }

    .table-wrapper {
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
      overflow: hidden;
      background: #f9fafb;
    }

    .table-scroll {
      max-height: 55vh;
      overflow: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
      min-width: 900px;
    }

    thead {
      position: sticky;
      top: 0;
      z-index: 1;
      background: #111827;
      color: white;
    }

    th,
    td {
      padding: 0.35rem 0.4rem;
      border-bottom: 1px solid #e5e7eb;
      vertical-align: top;
    }

    th {
      text-align: left;
      font-weight: 600;
      font-size: 0.75rem;
      white-space: nowrap;
    }

    th small {
      display: block;
      font-weight: 400;
      color: #d1d5db;
    }

    tbody tr:nth-child(even) {
      background: #f3f4f6;
    }

    tbody tr:hover {
      background: #e5e7eb;
    }

    td input[type="text"],
    td select,
    td textarea {
      background: transparent;
      border-radius: 0.4rem;
      padding: 0.25rem 0.35rem;
    }

    td textarea {
      min-height: 2rem;
    }

    .center {
      text-align: center;
    }

    .checkbox-cell {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .checkbox-cell input[type="checkbox"] {
      width: 1.1rem;
      height: 1.1rem;
    }

    .footer-hint {
      margin-top: 0.75rem;
      font-size: 0.7rem;
      color: #9ca3af;
      display: flex;
      justify-content: space-between;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.25rem;
      padding: 0.15rem 0.55rem;
      border-radius: 999px;
      background: #eef2ff;
      color: #4f46e5;
      font-size: 0.7rem;
    }

    @media (max-width: 900px) {
      body {
        padding: 0.5rem;
      }
      .app {
        padding: 0.9rem 0.75rem 1.1rem;
        border-radius: 0.75rem;
      }
      header {
        align-items: flex-start;
      }
      header h1 {
        font-size: 1.1rem;
      }
      .meta-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .toolbar {
        flex-direction: column;
        align-items: flex-start;
      }
      .table-wrapper {
        border-radius: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div>
        <h1>
          <span class="icon">üßæ</span>
          M√§ngelbericht ‚Äì Erfassung
        </h1>
        <div class="sub">
          Erfassung von M√§ngeln aus Wartungsberichten mit Foto-Referenzen
        </div>
      </div>
      <div class="badge">
        <span>üíæ</span>
        Speichert automatisch im Browser
      </div>
    </header>

    <!-- Kopfbereich -->
    <div class="section-title">
      <span>üìã</span>
      Kopfdaten
    </div>
    <div class="meta-grid">
      <div class="field">
        <label for="kunde">Kunde</label>
        <input id="kunde" type="text" placeholder="z. B. Mercedes Benz AG Werk 007" />
      </div>
      <div class="field">
        <label for="objekt">Objekt</label>
        <input
          id="objekt"
          type="text"
          placeholder="z. B. Funktionshalle, Hermann-K√∂ster-Str. 1, Bremen"
        />
      </div>
      <div class="field">
        <label for="gewerk">Gewerk</label>
        <select id="gewerk">
          <option value="">‚Äì Bitte w√§hlen ‚Äì</option>
          <option value="Loeschwassertechnik">L√∂schwassertechnik</option>
          <option value="Tragbare Feuerloescher">Tragbare Feuerl√∂scher</option>
          <option value="Fahrbare Feuerloescher">Fahrbare Feuerl√∂scher</option>
          <option value="RWA">RWA / Entrauchung</option>
          <option value="BrandschutzT√ºren">
            Brandschutz- und Rauchschutzt√ºren
          </option>
          <option value="Sonstiges">Sonstiges</option>
        </select>
      </div>
      <div class="field">
        <label for="berichtnr">Wartungsbericht-Nr.</label>
        <input id="berichtnr" type="text" placeholder="z. B. 993004257" />
      </div>

      <div class="field">
        <label for="datum-wartung">Datum der Wartung</label>
        <input id="datum-wartung" type="date" />
      </div>
      <div class="field">
        <label for="datum-begehung">Datum der Begehung</label>
        <input id="datum-begehung" type="date" />
      </div>
    </div>

    <!-- M√§ngelbereich -->
    <div class="section-title">
      <span>‚ùó</span>
      M√§ngelliste
    </div>

    <div class="toolbar">
      <div class="toolbar-left">
        <button id="add-row-btn" type="button">
          <span>‚ûï</span> Neuen Mangel hinzuf√ºgen
        </button>
        <button id="clear-table-btn" type="button" class="danger">
          <span>üóëÔ∏è</span> Tabelle leeren
        </button>
      </div>
      <div class="toolbar-right">
        <span class="hint">
          Tipp: Mangel-Nr. aus dem Wartungsbericht √ºbernehmen, Ma√ünahmen &amp; Fotos hier erfassen.
        </span>
      </div>
    </div>

    <div class="table-wrapper">
      <div class="table-scroll">
        <table id="maengel-table">
          <thead>
            <tr>
              <th style="width: 8rem;">
                Mangel-Nr.
                <small>aus Wartungsbericht</small>
              </th>
              <th style="width: 10rem;">
                Nummer / Bereich / Etage
                <small>z. B. 1.1, EG Flur Nord</small>
              </th>
              <th style="width: 14rem;">
                Ma√ünahme
                <small>z. B. Obent√ºrschlie√üer tauschen</small>
              </th>
              <th style="width: 7rem;">
                Dringlichkeit
                <small>f√ºr Priorisierung</small>
              </th>
              <th style="width: 5rem;" class="center">
                Foto gemacht?
              </th>
              <th style="width: 10rem;">
                Foto-Dateiname
                <small>z. B. IMG_1234.jpg</small>
              </th>
              <th>
                Bemerkung
                <small>Zusatzinfos</small>
              </th>
            </tr>
          </thead>
          <tbody>
            <!-- Zeilen werden per JS eingef√ºgt -->
          </tbody>
        </table>
      </div>
    </div>

    <div class="footer-hint">
      <div>
        <span class="pill">‚ÑπÔ∏è</span>
        Deine Eintr√§ge werden automatisch im Browser gespeichert. L√∂schen-Button
        leert Tabelle und Speicher.
      </div>
      <div>
        <span class="pill">üìÑ</span>
        F√ºr den Kundenbericht kannst du die Seite sp√§ter als PDF drucken.
      </div>
    </div>
  </div>

  <script>
    (function () {
      const STORAGE_KEY = "maengelbericht-app-v1";

      const appEl = document.getElementById("app");
      const tbody = document.querySelector("#maengel-table tbody");
      const addRowBtn = document.getElementById("add-row-btn");
      const clearTableBtn = document.getElementById("clear-table-btn");

      const metaFields = [
        "kunde",
        "objekt",
        "gewerk",
        "berichtnr",
        "datum-wartung",
        "datum-begehung",
      ];

      function getMeta() {
        const meta = {};
        metaFields.forEach((id) => {
          const el = document.getElementById(id);
          meta[id] = el ? el.value : "";
        });
        return meta;
      }

      function setMeta(meta) {
        if (!meta) return;
        metaFields.forEach((id) => {
          const el = document.getElementById(id);
          if (el && Object.prototype.hasOwnProperty.call(meta, id)) {
            el.value = meta[id];
          }
        });
      }

      function createRow(data = {}) {
        const tr = document.createElement("tr");

        tr.innerHTML = `
          <td>
            <input type="text" data-field="mangelNr" placeholder="z. B. 32611" />
          </td>
          <td>
            <input type="text" data-field="standort" placeholder="z. B. 1.1 / EG Flur" />
          </td>
          <td>
            <textarea data-field="massnahme" placeholder="z. B. Obent√ºrschlie√üer erneuern"></textarea>
          </td>
          <td>
            <select data-field="dringlichkeit">
              <option value="">‚Äì</option>
              <option value="normal">Normal</option>
              <option value="hoch">Hoch</option>
              <option value="sehr_hoch">Sehr hoch</option>
              <option value="akut">Akut</option>
            </select>
          </td>
          <td class="checkbox-cell">
            <input type="checkbox" data-field="fotoGemacht" />
          </td>
          <td>
            <input type="text" data-field="fotoDateiname" placeholder="IMG_1234.jpg" />
          </td>
          <td>
            <textarea data-field="bemerkung" placeholder="z. B. T√ºr klemmt stark, Nutzer informieren"></textarea>
          </td>
        `;

        // Vorbelegen, falls Daten vorhanden
        if (data) {
          const inputs = tr.querySelectorAll("[data-field]");
          inputs.forEach((el) => {
            const field = el.getAttribute("data-field");
            if (!field) return;
            const value = data[field];

            if (el.type === "checkbox") {
              el.checked = Boolean(value);
            } else if (
              typeof value === "string" ||
              typeof value === "number"
            ) {
              el.value = value;
            }
          });
        }

        attachRowListeners(tr);
        return tr;
      }

      function attachRowListeners(tr) {
        const inputs = tr.querySelectorAll(
          "input[data-field], select[data-field], textarea[data-field]"
        );
        inputs.forEach((el) => {
          const evt = el.tagName === "SELECT" ? "change" : "input";
          el.addEventListener(evt, saveAll);
          if (el.type === "checkbox") {
            el.addEventListener("change", saveAll);
          }
        });
      }

      function getRows() {
        const rows = [];
        const trs = tbody.querySelectorAll("tr");
        trs.forEach((tr) => {
          const rowData = {
            mangelNr: "",
            standort: "",
            massnahme: "",
            dringlichkeit: "",
            fotoGemacht: false,
            fotoDateiname: "",
            bemerkung: "",
          };
          const inputs = tr.querySelectorAll("[data-field]");
          inputs.forEach((el) => {
            const field = el.getAttribute("data-field");
            if (!field) return;
            if (el.type === "checkbox") {
              rowData[field] = el.checked;
            } else {
              rowData[field] = el.value;
            }
          });
          // Nur speichern, wenn nicht komplett leer
          const values = Object.values(rowData).join("").trim();
          if (values !== "") {
            rows.push(rowData);
          }
        });
        return rows;
      }

      function saveAll() {
        const meta = getMeta();
        const rows = getRows();
        const payload = { meta, rows };

        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
        } catch (err) {
          console.error("Speichern fehlgeschlagen:", err);
        }
      }

      function loadAll() {
        let payload = null;
        try {
          const raw = localStorage.getItem(STORAGE_KEY);
          if (raw) {
            payload = JSON.parse(raw);
          }
        } catch (err) {
          console.error("Laden fehlgeschlagen:", err);
        }

        if (payload && payload.meta) {
          setMeta(payload.meta);
        }

        tbody.innerHTML = "";

        if (payload && Array.isArray(payload.rows) && payload.rows.length) {
          payload.rows.forEach((row) => {
            const tr = createRow(row);
            tbody.appendChild(tr);
          });
        } else {
          // Wenn noch keine Daten da sind: 3 leere Zeilen
          for (let i = 0; i < 3; i++) {
            const tr = createRow();
            tbody.appendChild(tr);
          }
        }
      }

      function clearTable() {
        const ok = window.confirm(
          "Alle M√§ngel aus Tabelle und Zwischenspeicher l√∂schen?"
        );
        if (!ok) return;
        tbody.innerHTML = "";
        for (let i = 0; i < 3; i++) {
          const tr = createRow();
          tbody.appendChild(tr);
        }
        saveAll();
      }

      // Event Listener Kopf
      metaFields.forEach((id) => {
        const el = document.getElementById(id);
        if (!el) return;
        const evt = el.tagName === "SELECT" ? "change" : "input";
        el.addEventListener(evt, saveAll);
      });

      // Buttons
      addRowBtn.addEventListener("click", () => {
        const tr = createRow();
        tbody.appendChild(tr);
        saveAll();
        // etwas nach unten scrollen, damit neue Zeile sichtbar ist
        tr.scrollIntoView({ behavior: "smooth", block: "nearest" });
      });

      clearTableBtn.addEventListener("click", clearTable);

      // Initial
      loadAll();
    })();
  </script>
</body>
</html>
